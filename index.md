## iOS å¯¹è±¡æ‘¸é±¼ - allocæµç¨‹åˆ†æ
### 1. alloc åšäº†å•¥
åœ¨ä¸šåŠ¡å±‚å¼€å‘æ—¶ï¼Œå¾ˆå°‘ä¼šå¯¹Objcæºç è¿›è¡Œæ¢ç©¶ã€‚æ‰€ä»¥å¯¹ç³»ç»Ÿæ–¹æ³•çš„åº•å±‚å®ç°ï¼Œå¾€å¾€ä¸å¾—è€ŒçŸ¥ï¼Œæœ›è€Œå´æ­¥ã€‚

ä¸‹é¢ç½—åˆ—æŸ¥æ‰¾æºç çš„3ä¸ªæ–¹æ³•ï¼š

    1.  é€šè¿‡ç¬¦å·æ–­ç‚¹ä¸€æ­¥æ­¥æ‰§è¡Œ
    2.  ctrl + step into
    3.  è¿è¡Œæ—¶æ±‡ç¼–ä»£ç ï¼Œå¼€å¯æ±‡ç¼–è°ƒè¯•ã€‚å…·ä½“å¼€å¯æ–¹æ³•ï¼š`ï¼ˆXcode->Debug->Debug workflow->Always Show Disassemblyï¼‰`

###### ä¸¾ğŸŒ°ï¼ˆæ’¸ä»£ç ï¼‰ï¼š

åœ¨æµ‹è¯•é¡¹ç›®æ–°å»ºä¸€ä¸ªç»§æ‰¿`NSObject`çš„ç±»ï¼Œå¹¶`alloc`å‡ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼š

`FLObject *object = [FLObject alloc];`

æ‰“å¥½æ–­ç‚¹åè¿è¡Œï¼Œå¹¶å¼€å¯æ±‡ç¼–è°ƒè¯•ï¼ŒæŸ¥çœ‹è¿è¡Œæ—¶æ±‡ç¼–ä»£ç 

![symbol](symbol.png)

å¦‚å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ±‡ç¼–æ³¨é‡Š`symbol stub for: objc_alloc`å¾—çŸ¥ç«‹å³è°ƒç”¨å­˜æ ¹ç¬¦å·ä¸º`objc_alloc`çš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¦¨å¢åŠ ä¸€ä¸ª`objc_alloc`çš„ç¬¦å·æ–­ç‚¹ï¼Œæ¥ç€è¿è¡Œå¯ä»¥çœ‹åˆ°

![libObjc](libObjc.png)

æ‰€ä»¥å¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ `FLObject *object = [FLObject alloc];`   æ—¶ï¼Œåº•å±‚è°ƒç”¨ä¸º`libobjc.A.dylib`åŠ¨æ€é“¾æ¥åº“ä¸­çš„`objc_alloc`æ–¹æ³•ã€‚

é€šè¿‡[è‹¹æœå¼€æºåº“](è¶…é“¾æ¥åœ°å€ "https://opensource.apple.com/")å¯ä»¥ä¸‹è½½ç›¸å…³å¼€æºåº“ã€‚

*æ³¨ï¼šcallqï¼šå±äºx86çš„æŒ‡ä»¤ï¼Œå³è°ƒç”¨å‡½æ•°æ—¶çš„å‹æ ˆå‡ºæ ˆã€‚å›¾ä¸€ä¸­`callq`æŒ‡ä»¤ä¼šä½¿ç¨‹åºè·³åˆ°`0x10934b30`çš„åœ°å€ä¸­æ‰§è¡Œã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥æŒ‡ä»¤è¿˜ä¼šå°†å½“å‰å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤å…¥æ ˆ*

### 2.alloc&init æ¢ç´¢

æ€»æ‰€å‘¨çŸ¥ï¼š`alloc`çš„è°ƒç”¨æ˜¯ä¸ºå¯¹è±¡å¼€è¾Ÿå†…å­˜ï¼Œå…·ä½“å¦‚ä½•å®ç° åœ¨æ‹¿åˆ°çš„`Objc`æºç ä¸­ä¸€æ¢ç©¶ç«Ÿã€‚

###### æ€ä¹ˆç©ï¼Ÿ

æŸ¥çœ‹`alloc` å®ç°: å†…éƒ¨è°ƒç”¨ `_rootAlloc` , ->

å†è°ƒç”¨`callAlloc`ï¼Œ->

è€Œ`callAlloc`å†…éƒ¨ç»è¿‡ç¼–è¾‘å™¨ä¼˜åŒ–åˆ¤æ–­ï¼Œå†è°ƒç”¨`_objc_rootAllocWithZone`ã€‚

```
NEVER_INLINE
id
_objc_rootAllocWithZone(Class cls, malloc_zone_t *zone __unused)
{
    // allocWithZone under __OBJC2__ ignores the zone parameter
    return _class_createInstanceFromZone(cls, 0, nil,
                                         OBJECT_CONSTRUCT_CALL_BADALLOC);
}

```
`_objc_rootAllocWithZone` ä¸¤ä¸ªå‚æ•°ï¼šç±»ååŠzoneï¼›->

æ­¤æ—¶ä¼šè°ƒç”¨`_class_createInstanceFromZone`ã€‚ è¿™é‡Œç€é‡çœ‹ä¸‹å®ƒçš„å†…éƒ¨å®ç°ï¼š

1. size å³éœ€è¦å¼€è¾Ÿçš„å†…å­˜ç©ºé—´
```
size = cls->instanceSize(extraBytes);
```


2. calloc å¼€è¾Ÿå†…å­˜çš„åœ°æ–¹ï¼Œè°ƒç”¨åè¿”å›å†…å­˜åœ°å€
```
obj = (id)calloc(1, size);
```

3. å°†å¼€è¾Ÿçš„å†…å­˜ä¸å½“å‰ç±»è¿›è¡Œç»‘å®š
```
obj->initInstanceIsa(cls, hasCxxDtor);
```
4. æœ€åè¿”å›è¯¥`obj`

